<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAMV Agent Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/>
                </svg>
            </div>
            <div>
                <h1 class="header-title">MAMV Agent Dashboard</h1>
                <p class="header-sub" id="headerTime"></p>
            </div>
        </div>
        <div class="header-right">
            <div class="header-stat">
                <span class="header-stat-val" style="color:#0f8a5f;">5</span>
                <span class="header-stat-label">Active</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-val" style="color:#c67a08;">2</span>
                <span class="header-stat-label">Idle</span>
            </div>
            <div class="header-stat">
                <span class="header-stat-val" style="color:#c4163a;">1</span>
                <span class="header-stat-label">Error</span>
            </div>
            <button class="header-btn-primary" onclick="openNewTaskModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                New Task
            </button>
        </div>
    </header>

    <!-- Metrics Bar -->
    <div class="metrics-bar">
        <div class="metrics-inner">
            <div class="metric-card">
                <div class="metric-icon" style="background:rgba(43,125,233,0.08);color:#2b7de9;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                </div>
                <div class="metric-data">
                    <div class="metric-val">12</div>
                    <div class="metric-label">Pages Generated</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background:rgba(91,95,207,0.08);color:#5b5fcf;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                </div>
                <div class="metric-data">
                    <div class="metric-val">5</div>
                    <div class="metric-label">Emails Drafted</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background:rgba(124,58,237,0.08);color:#7c3aed;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </div>
                <div class="metric-data">
                    <div class="metric-val">3</div>
                    <div class="metric-label">Posts Written</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background:rgba(198,122,8,0.08);color:#c67a08;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
                </div>
                <div class="metric-data">
                    <div class="metric-val">470K</div>
                    <div class="metric-label">Total Tokens</div>
                </div>
            </div>
            <div class="metric-card">
                <div class="metric-icon" style="background:rgba(15,138,95,0.08);color:#0f8a5f;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                </div>
                <div class="metric-data">
                    <div class="metric-val">$0.40</div>
                    <div class="metric-label">Total Cost</div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Body: Sidebar + Main -->
    <div class="app-body">
        <!-- Agent Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                Agents
            </div>
            <div class="sidebar-agents" id="agentList"></div>
        </aside>

        <!-- Mobile Agent Bar (horizontal scroll) -->
        <div class="mobile-agent-bar" id="mobileAgentBar"></div>

        <!-- Main Content -->
        <main class="main">
            <!-- Task Board -->
            <section class="section task-section">
                <h2 class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                    Task Board
                </h2>
                <div class="filter-bar">
                    <div class="filter-group">
                        <label class="filter-label">Agent</label>
                        <div class="multi-select" id="agentFilter">
                            <button class="multi-select-btn" id="agentFilterBtn">All Agents <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></button>
                            <div class="multi-select-dropdown" id="agentFilterDropdown"></div>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <div class="multi-select" id="statusFilter">
                            <button class="multi-select-btn" id="statusFilterBtn">All Statuses <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg></button>
                            <div class="multi-select-dropdown" id="statusFilterDropdown"></div>
                        </div>
                    </div>
                    <div class="view-toggle" id="viewToggle">
                        <button class="view-toggle-btn active" id="listViewBtn" title="List view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                        </button>
                        <button class="view-toggle-btn" id="kanbanViewBtn" title="Board view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="12" rx="1"/></svg>
                        </button>
                    </div>
                    <div class="filter-count" id="filterCount">15 tasks</div>
                </div>
                <div class="task-list" id="taskList"></div>
                <div class="kanban-board" id="kanbanBoard" style="display:none;"></div>
            </section>

            <!-- Activity Feed -->
            <section class="section activity-section">
                <h2 class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                    Activity Feed
                </h2>
                <div class="activity-feed" id="activityFeed"></div>
            </section>

            <!-- Alert Log -->
            <section class="section alert-section">
                <h2 class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    Alert Log
                </h2>
                <div class="alert-log" id="alertLog"></div>
            </section>
        </main>
    </div>

    <!-- Task Detail Panel -->
    <div class="modal-overlay" id="taskDetailModal">
        <div class="task-detail-panel">
            <div class="task-detail-header">
                <div class="task-detail-header-top">
                    <span class="task-detail-status" id="taskDetailStatus">In Progress</span>
                    <button class="task-detail-close" onclick="closeModal('taskDetailModal')">‚úï</button>
                </div>
                <h2 class="task-detail-title" id="taskDetailTitle">Task Title</h2>
                <div class="task-detail-meta">
                    <span class="task-detail-agent" id="taskDetailAgent">
                        <img src="" id="taskDetailAgentAvatar" class="task-detail-agent-avatar">
                        <span id="taskDetailAgentName">Agent</span>
                    </span>
                    <span class="task-detail-priority" id="taskDetailPriority">Medium</span>
                </div>
            </div>
            
            <div class="task-detail-body">
                <!-- Agent's Plan Section -->
                <div class="task-detail-section">
                    <div class="task-detail-section-header">
                        <span class="task-detail-section-icon">ü§ñ</span>
                        <h3>Agent's Plan</h3>
                    </div>
                    <div class="agent-plan" id="agentPlan">
                        <div class="agent-plan-content" id="agentPlanContent">
                            <!-- Agent's approach will be shown here -->
                        </div>
                        <div class="agent-plan-meta" id="agentPlanMeta"></div>
                    </div>
                </div>
                
                <!-- Your Context Section -->
                <div class="task-detail-section">
                    <div class="task-detail-section-header">
                        <span class="task-detail-section-icon">üë§</span>
                        <h3>Your Input</h3>
                    </div>
                    
                    <div class="existing-context" id="existingContext" style="display:none;">
                        <div class="existing-context-label">Previous Context</div>
                        <div class="existing-context-text" id="existingContextText"></div>
                        <div class="existing-context-meta" id="existingContextMeta"></div>
                    </div>
                    
                    <div class="modal-field">
                        <label>Add Context, Instructions, or Message to Agent</label>
                        <textarea id="contextInput" placeholder="Add clarification, redirect the approach, or send a message to the agent..."></textarea>
                    </div>
                    
                    <div class="task-detail-options">
                        <div class="modal-field compact">
                            <label>Priority</label>
                            <select id="prioritySelect">
                                <option value="">No change</option>
                                <option value="High">üî• High</option>
                                <option value="Medium">‚ö° Medium</option>
                                <option value="Low">üìã Low</option>
                            </select>
                        </div>
                        <div class="modal-field compact">
                            <label>Notify</label>
                            <select id="notifySelect">
                                <option value="next">Next heartbeat</option>
                                <option value="immediate">Immediately</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Log -->
                <div class="task-detail-section">
                    <div class="task-detail-section-header">
                        <span class="task-detail-section-icon">üìã</span>
                        <h3>Activity</h3>
                    </div>
                    <div class="task-activity" id="taskActivity">
                        <!-- Activity items will be shown here -->
                    </div>
                </div>
            </div>
            
            <div class="task-detail-footer">
                <button class="modal-btn secondary" onclick="closeModal('taskDetailModal')">Close</button>
                <button class="modal-btn primary" onclick="saveTaskInput()">Save & Notify Agent</button>
            </div>
        </div>
    </div>

    <!-- New Task Modal -->
    <div class="modal-overlay" id="newTaskModal">
        <div class="modal">
            <h3 class="modal-title">New Task</h3>
            
            <div class="modal-field">
                <label>Task Title</label>
                <input type="text" id="newTaskTitle" placeholder="What needs to be done?">
            </div>
            
            <div class="modal-field">
                <label>Assign To</label>
                <select id="newTaskAgent">
                    <option value="">Auto-assign (Loki decides)</option>
                    <option value="Beacon">Beacon (SEO)</option>
                    <option value="Pixel">Pixel (Copywriting)</option>
                    <option value="Cass">Cass (Research)</option>
                    <option value="Forge">Forge (Email)</option>
                    <option value="Radar">Radar (Social)</option>
                    <option value="Atlas">Atlas (Analytics)</option>
                </select>
            </div>
            
            <div class="modal-field">
                <label>Priority</label>
                <select id="newTaskPriority">
                    <option value="Medium">‚ö° Medium ‚Äî This Week</option>
                    <option value="High">üî• High ‚Äî Today</option>
                    <option value="Low">üìã Low ‚Äî Backlog</option>
                </select>
            </div>
            
            <div class="modal-field">
                <label>Context (optional)</label>
                <textarea id="newTaskContext" placeholder="Add any context or instructions..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('newTaskModal')">Cancel</button>
                <button class="modal-btn primary" onclick="createNewTask()">Create Task</button>
            </div>
        </div>
    </div>

    <script>
    // ---- Modal Functions (global scope) ----
    let currentTaskIndex = null;

    const agentAvatars = {
        'Loki': 'avatars/loki.png',
        'Beacon': 'avatars/beacon.png',
        'Pixel': 'avatars/pixel.png',
        'Cass': 'avatars/cass.png',
        'Forge': 'avatars/forge.png',
        'Radar': 'avatars/radar.png',
        'Atlas': 'avatars/atlas.png'
    };

    function openTaskDetail(taskIndex) {
        currentTaskIndex = taskIndex;
        const task = window.dashboardTasks[taskIndex];
        
        // Header info
        document.getElementById('taskDetailTitle').textContent = task.name;
        document.getElementById('taskDetailStatus').textContent = task.status;
        document.getElementById('taskDetailStatus').className = 'task-detail-status status-' + task.status.toLowerCase().replace(' ', '-');
        document.getElementById('taskDetailAgentName').textContent = task.agent;
        document.getElementById('taskDetailAgentAvatar').src = agentAvatars[task.agent] || 'avatars/loki.png';
        document.getElementById('taskDetailPriority').textContent = task.priority;
        document.getElementById('taskDetailPriority').className = 'task-detail-priority priority-' + task.priority.toLowerCase();
        
        // Agent's plan
        const planContent = document.getElementById('agentPlanContent');
        const planMeta = document.getElementById('agentPlanMeta');
        if (task.agentPlan) {
            planContent.innerHTML = task.agentPlan.split('\n').map(line => 
                line.startsWith('‚Ä¢') || line.startsWith('-') 
                    ? `<div class="plan-step">${line}</div>`
                    : `<div class="plan-line">${line}</div>`
            ).join('');
            planMeta.textContent = `Last updated by ${task.agent} ¬∑ ${task.planUpdated || 'recently'}`;
        } else {
            planContent.innerHTML = '<div class="plan-empty">Agent hasn\'t created a plan yet. They\'ll outline their approach on the next heartbeat.</div>';
            planMeta.textContent = '';
        }
        
        // Existing context
        const existingEl = document.getElementById('existingContext');
        if (task.context) {
            existingEl.style.display = 'block';
            document.getElementById('existingContextText').textContent = '"' + task.context + '"';
            document.getElementById('existingContextMeta').textContent = 'Added by ' + (task.contextBy || 'Mike') + ' ¬∑ ' + (task.contextTime || 'recently');
        } else {
            existingEl.style.display = 'none';
        }
        
        // Activity log
        const activityEl = document.getElementById('taskActivity');
        if (task.activity && task.activity.length > 0) {
            activityEl.innerHTML = task.activity.map(a => `
                <div class="activity-item">
                    <span class="activity-dot" style="background:${a.color || '#8892a4'}"></span>
                    <div class="activity-content">
                        <span class="activity-text">${a.text}</span>
                        <span class="activity-time">${a.time}</span>
                    </div>
                </div>
            `).join('');
        } else {
            activityEl.innerHTML = '<div class="activity-empty">No activity yet</div>';
        }
        
        // Reset input
        document.getElementById('contextInput').value = '';
        document.getElementById('prioritySelect').value = '';
        
        document.getElementById('taskDetailModal').classList.add('active');
    }

    // Legacy function for backwards compatibility
    function openContextModal(taskIndex) {
        openTaskDetail(taskIndex);
    }

    function openMessageModal(agentName) {
        // Find a task for this agent to open the detail panel
        const taskIndex = window.dashboardTasks.findIndex(t => t.agent === agentName);
        if (taskIndex >= 0) {
            openTaskDetail(taskIndex);
        }
    }

    function openNewTaskModal() {
        document.getElementById('newTaskTitle').value = '';
        document.getElementById('newTaskContext').value = '';
        document.getElementById('newTaskModal').classList.add('active');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function saveTaskInput() {
        const text = document.getElementById('contextInput').value.trim();
        const priority = document.getElementById('prioritySelect').value;
        
        if (currentTaskIndex !== null) {
            if (text) {
                // Add to context
                window.dashboardTasks[currentTaskIndex].context = text;
                window.dashboardTasks[currentTaskIndex].contextBy = 'Mike';
                window.dashboardTasks[currentTaskIndex].contextTime = 'just now';
                
                // Add to activity
                if (!window.dashboardTasks[currentTaskIndex].activity) {
                    window.dashboardTasks[currentTaskIndex].activity = [];
                }
                window.dashboardTasks[currentTaskIndex].activity.unshift({
                    text: 'Mike added context: "' + text.substring(0, 50) + (text.length > 50 ? '...' : '') + '"',
                    time: 'just now',
                    color: '#2b7de9'
                });
            }
            
            if (priority) {
                window.dashboardTasks[currentTaskIndex].priority = priority;
                if (!window.dashboardTasks[currentTaskIndex].activity) {
                    window.dashboardTasks[currentTaskIndex].activity = [];
                }
                window.dashboardTasks[currentTaskIndex].activity.unshift({
                    text: 'Mike changed priority to ' + priority,
                    time: 'just now',
                    color: '#c67a08'
                });
            }
            
            window.rerenderTasks();
            alert('‚úì Saved! Agent will see this on next heartbeat.');
        }
        closeModal('taskDetailModal');
    }

    function createNewTask() {
        const title = document.getElementById('newTaskTitle').value.trim();
        if (title) {
            const agent = document.getElementById('newTaskAgent').value || 'Loki';
            const priority = document.getElementById('newTaskPriority').value;
            const context = document.getElementById('newTaskContext').value.trim();
            
            window.dashboardTasks.unshift({
                name: title,
                agent: agent,
                status: 'Queued',
                priority: priority,
                started: '-',
                tags: [],
                context: context || null,
                contextBy: context ? 'Mike' : null,
                contextTime: context ? 'just now' : null,
                agentPlan: null,
                activity: [{
                    text: 'Task created by Mike',
                    time: 'just now',
                    color: '#0f8a5f'
                }]
            });
            window.rerenderTasks();
            alert('‚úì Task created!');
        }
        closeModal('newTaskModal');
    }

    // Close modals on overlay click or Escape
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) overlay.classList.remove('active');
        });
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
    });

    (function() {
        'use strict';

        // ---- Update header time ----
        function updateTime() {
            const now = new Date();
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('headerTime').textContent = now.toLocaleDateString('en-US', opts);
        }
        updateTime();
        setInterval(updateTime, 30000);

        // ---- Agent Data ----
        const agents = [
            { name: 'Loki', role: 'Orchestrator', status: 'active', model: 'Claude Sonnet', task: 'Reviewing SEO agent output', tokens: '45K', cost: '$0.12', heartbeat: '2 min ago', color: '#2b7de9', avatar: 'avatars/loki.png' },
            { name: 'Beacon', role: 'SEO Specialist', status: 'active', model: 'Kimi 2.5', task: 'Generating product comparison pages for HTMLDecks', tokens: '120K', cost: '$0.08', heartbeat: '5 min ago', color: '#0d8aba', avatar: 'avatars/beacon.png' },
            { name: 'Pixel', role: 'Copywriter', status: 'idle', model: 'Kimi 2.5', task: 'Wrote 3 blog posts', tokens: '80K', cost: '$0.05', heartbeat: '22 min ago', color: '#5b5fcf', avatar: 'avatars/pixel.png' },
            { name: 'Cass', role: 'Research Analyst', status: 'active', model: 'Kimi 2.5', task: 'Competitor analysis: Canva alternatives', tokens: '95K', cost: '$0.06', heartbeat: '8 min ago', color: '#7c3aed', avatar: 'avatars/cass.png' },
            { name: 'Forge', role: 'Email Marketing', status: 'active', model: 'Kimi 2.5', task: 'Building welcome drip for PageBuilderHQ', tokens: '60K', cost: '$0.04', heartbeat: '12 min ago', color: '#c67a08', avatar: 'avatars/forge.png' },
            { name: 'Radar', role: 'Social Media', status: 'error', model: 'Kimi 2.5', task: 'Twitter API rate limited', tokens: '30K', cost: '$0.02', heartbeat: '45 min ago', color: '#c4163a', avatar: 'avatars/radar.png' },
            { name: 'Atlas', role: 'Analytics', status: 'idle', model: 'Kimi 2.5', task: 'Weekly traffic report', tokens: '40K', cost: '$0.03', heartbeat: '35 min ago', color: '#0f8a5f', avatar: 'avatars/atlas.png' }
        ];

        const statusColors = { active: '#0f8a5f', idle: '#c67a08', error: '#c4163a' };
        const statusLabels = { active: 'Active', idle: 'Idle', error: 'Error' };

        // ---- Render Sidebar Agents ----
        let selectedAgent = null;

        function renderSidebarAgents() {
            const list = document.getElementById('agentList');
            const mobileBar = document.getElementById('mobileAgentBar');
            list.innerHTML = '';
            mobileBar.innerHTML = '';

            agents.forEach(a => {
                // Get active tasks for this agent
                const agentTasks = tasks.filter(t => t.agent === a.name && t.status !== 'Completed');
                const taskBullets = agentTasks.length > 0 
                    ? agentTasks.map(t => `<li class="sidebar-agent-bullet">${t.name}</li>`).join('')
                    : `<li class="sidebar-agent-bullet sidebar-agent-bullet--idle">No active tasks</li>`;

                // Desktop sidebar item
                const item = document.createElement('button');
                item.className = 'sidebar-agent' + (selectedAgent === a.name ? ' selected' : '');
                item.dataset.color = a.color;
                if (selectedAgent === a.name) item.style.setProperty('--agent-glow', a.color);
                item.innerHTML = `
                    <div class="sidebar-agent-top">
                        <img class="sidebar-agent-avatar" src="${a.avatar}" alt="${a.name}">
                        <div class="sidebar-agent-info">
                            <div class="sidebar-agent-name-row">
                                <span class="sidebar-dot status-dot-${a.status}"></span>
                                <span class="sidebar-agent-name">${a.name}</span>
                            </div>
                            <span class="sidebar-agent-role-badge" style="background:${a.color};">${a.role}</span>
                        </div>
                    </div>
                    <ul class="sidebar-agent-tasks">${taskBullets}</ul>
                `;
                item.addEventListener('click', () => {
                    selectedAgent = selectedAgent === a.name ? null : a.name;
                    renderSidebarAgents();
                    highlightAgentTasks();
                });
                list.appendChild(item);

                // Mobile horizontal item
                const chip = document.createElement('button');
                chip.className = 'mobile-agent-chip' + (selectedAgent === a.name ? ' selected' : '');
                chip.innerHTML = `<span class="sidebar-dot status-dot-${a.status}"></span>${a.name}`;
                chip.addEventListener('click', () => {
                    selectedAgent = selectedAgent === a.name ? null : a.name;
                    renderSidebarAgents();
                    highlightAgentTasks();
                });
                mobileBar.appendChild(chip);
            });
        }

        function highlightAgentTasks() {
            const agentColor = selectedAgent ? getAgentColor(selectedAgent) : null;
            document.querySelectorAll('.task-row').forEach(row => {
                row.style.removeProperty('--agent-glow');
                if (!selectedAgent) {
                    row.classList.remove('highlight', 'dimmed');
                } else if (row.dataset.agent === selectedAgent) {
                    row.classList.add('highlight');
                    row.classList.remove('dimmed');
                    row.style.setProperty('--agent-glow', agentColor);
                } else {
                    row.classList.add('dimmed');
                    row.classList.remove('highlight');
                }
            });
        }

        // ---- Task Data (must be before renderSidebarAgents) ----
        const tasks = [
            { 
                name: 'Generate 12 product comparison pages', 
                agent: 'Beacon', 
                status: 'In Progress', 
                priority: 'High', 
                started: '9:15 AM', 
                tags: ['#seo', '#htmldecks'], 
                context: 'Focus on HTML Decks vs Canva, Pitch, and Google Slides comparisons.', 
                contextBy: 'Mike', 
                contextTime: '2h ago',
                agentPlan: '‚Ä¢ Research top 5 competitors for HTML presentation tools\n‚Ä¢ Create comparison matrix (features, pricing, pros/cons)\n‚Ä¢ Generate 12 landing pages using pSEO template\n‚Ä¢ Include schema markup for rich snippets\n‚Ä¢ Submit to sitemap after generation',
                planUpdated: '1h ago',
                activity: [
                    { text: 'Generated 8/12 comparison pages', time: '30m ago', color: '#0f8a5f' },
                    { text: 'Mike added context about competitors', time: '2h ago', color: '#2b7de9' },
                    { text: 'Task started', time: '3h ago', color: '#8892a4' }
                ]
            },
            { 
                name: 'Review SEO agent output batch', 
                agent: 'Loki', 
                status: 'In Progress', 
                priority: 'High', 
                started: '10:00 AM', 
                tags: ['#review', '#quality'], 
                context: null,
                agentPlan: '‚Ä¢ Review 12 generated pages for quality\n‚Ä¢ Check keyword density and placement\n‚Ä¢ Verify schema markup is correct\n‚Ä¢ Flag any thin content for revision\n‚Ä¢ Approve batch for publishing',
                planUpdated: '15m ago',
                activity: [
                    { text: 'Reviewed 4/12 pages', time: '10m ago', color: '#0f8a5f' },
                    { text: 'Task started', time: '30m ago', color: '#8892a4' }
                ]
            },
            { 
                name: 'Competitor analysis: Canva alternatives', 
                agent: 'Cass', 
                status: 'In Progress', 
                priority: 'Medium', 
                started: '8:30 AM', 
                tags: ['#research', '#competitive'], 
                context: 'Include pricing comparison and feature matrix.', 
                contextBy: 'Mike', 
                contextTime: '3h ago',
                agentPlan: '‚Ä¢ Identify top 10 Canva competitors\n‚Ä¢ Deep dive into features, pricing tiers\n‚Ä¢ Create comparison spreadsheet\n‚Ä¢ Analyze positioning and messaging\n‚Ä¢ Draft executive summary with recommendations',
                planUpdated: '2h ago',
                activity: [
                    { text: 'Completed research on 6/10 competitors', time: '1h ago', color: '#0f8a5f' },
                    { text: 'Mike requested pricing comparison', time: '3h ago', color: '#2b7de9' }
                ]
            },
            { 
                name: 'Build welcome drip for PageBuilderHQ', 
                agent: 'Forge', 
                status: 'In Progress', 
                priority: 'High', 
                started: '9:45 AM', 
                tags: ['#email', '#pagebuilderhq'], 
                context: null,
                agentPlan: '‚Ä¢ Design 5-email welcome sequence\n‚Ä¢ Email 1: Welcome + quick start guide\n‚Ä¢ Email 2: Feature highlight (templates)\n‚Ä¢ Email 3: Case study / social proof\n‚Ä¢ Email 4: Tips & best practices\n‚Ä¢ Email 5: Upgrade offer with discount',
                planUpdated: '45m ago',
                activity: [
                    { text: 'Drafted emails 1-3', time: '30m ago', color: '#0f8a5f' }
                ]
            },
            { name: 'Write blog post: "HTML vs PDF Presentations"', agent: 'Pixel', status: 'Completed', priority: 'Medium', started: '7:00 AM', tags: ['#content', '#htmldecks'], context: null, agentPlan: null, activity: [] },
            { name: 'Write blog post: "5 Landing Page Mistakes"', agent: 'Pixel', status: 'Completed', priority: 'Medium', started: '8:00 AM', tags: ['#content', '#pagebuilderhq'], context: null, agentPlan: null, activity: [] },
            { name: 'Write blog post: "Email Template Best Practices"', agent: 'Pixel', status: 'Completed', priority: 'Low', started: '8:45 AM', tags: ['#content', '#emailkits'], context: null, agentPlan: null, activity: [] },
            { name: 'Post Twitter thread on pSEO strategy', agent: 'Radar', status: 'Blocked', priority: 'Medium', started: '10:30 AM', tags: ['#social', '#twitter'], context: null, agentPlan: '‚Ä¢ Draft 10-tweet thread on pSEO\n‚Ä¢ Include examples from HTMLDecks\n‚Ä¢ Add relevant images/screenshots', planUpdated: '2h ago', activity: [{ text: 'Hit Twitter API rate limit', time: '45m ago', color: '#c4163a' }] },
            { name: 'Weekly traffic report compilation', agent: 'Atlas', status: 'Completed', priority: 'Medium', started: '6:00 AM', tags: ['#analytics', '#report'], context: null, agentPlan: null, activity: [] },
            { name: 'Draft cold email sequence for HireLoki', agent: 'Forge', status: 'Queued', priority: 'Medium', started: '-', tags: ['#email', '#hireloki'], context: null, agentPlan: null, activity: [] },
            { name: 'Keyword gap analysis: EmailKits vs competitors', agent: 'Beacon', status: 'Queued', priority: 'Medium', started: '-', tags: ['#seo', '#emailkits'], context: null, agentPlan: null, activity: [] },
            { name: 'Generate FAQ schema for all product pages', agent: 'Beacon', status: 'Queued', priority: 'Low', started: '-', tags: ['#seo', '#schema'], context: null, agentPlan: null, activity: [] },
            { name: 'Review and approve 3 email campaigns', agent: 'Loki', status: 'Completed', priority: 'High', started: '8:30 AM', tags: ['#review', '#email'], context: null, agentPlan: null, activity: [] },
            { name: 'Update pricing page copy', agent: 'Pixel', status: 'Queued', priority: 'Low', started: '-', tags: ['#content', '#copy'], context: null, agentPlan: null, activity: [] },
            { 
                name: 'Research DME market acquisition targets', 
                agent: 'Cass', 
                status: 'Queued', 
                priority: 'Low', 
                started: '-', 
                tags: ['#research', '#dme'], 
                context: 'Focus on Southeast region. Dad mentioned interest in FL/GA markets.', 
                contextBy: 'Mike', 
                contextTime: '1d ago',
                agentPlan: null,
                activity: [{ text: 'Mike added context about SE region', time: '1d ago', color: '#2b7de9' }]
            }
        ];

        // Make tasks available globally for modal functions
        window.dashboardTasks = tasks;

        const priorityColors = { High: '#c4163a', Medium: '#c67a08', Low: '#8892a4' };
        const statusTaskColors = { 'In Progress': '#2b7de9', 'Completed': '#0f8a5f', 'Queued': '#8892a4', 'Blocked': '#c4163a' };

        // ---- Multi-Select Filters ----
        const agentNames = ['All Agents', 'Loki', 'Beacon', 'Pixel', 'Cass', 'Forge', 'Radar', 'Atlas', 'Mike'];
        const statusNames = ['All', 'In Progress', 'Completed', 'Queued', 'Blocked'];

        let selectedAgents = new Set(['All Agents']);
        let selectedStatuses = new Set(['All']);

        function buildDropdown(container, items, selectedSet, onUpdate) {
            container.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'dropdown-item';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = selectedSet.has(item);
                cb.addEventListener('change', () => {
                    const allKey = items[0];
                    if (item === allKey) {
                        selectedSet.clear();
                        selectedSet.add(allKey);
                    } else {
                        selectedSet.delete(allKey);
                        if (cb.checked) selectedSet.add(item);
                        else selectedSet.delete(item);
                        if (selectedSet.size === 0) selectedSet.add(allKey);
                    }
                    buildDropdown(container, items, selectedSet, onUpdate);
                    onUpdate();
                });
                label.appendChild(cb);
                label.appendChild(document.createTextNode(' ' + item));
                container.appendChild(label);
            });
        }

        function updateFilterBtnText() {
            const agentBtn = document.getElementById('agentFilterBtn');
            const statusBtn = document.getElementById('statusFilterBtn');
            if (selectedAgents.has('All Agents')) agentBtn.innerHTML = 'All Agents <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
            else agentBtn.innerHTML = [...selectedAgents].join(', ') + ' <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
            if (selectedStatuses.has('All')) statusBtn.innerHTML = 'All Statuses <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
            else statusBtn.innerHTML = [...selectedStatuses].join(', ') + ' <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            const filtered = tasks.filter(t => {
                const agentMatch = selectedAgents.has('All Agents') || selectedAgents.has(t.agent);
                const statusMatch = selectedStatuses.has('All') || selectedStatuses.has(t.status);
                return agentMatch && statusMatch;
            });
            document.getElementById('filterCount').textContent = filtered.length + ' task' + (filtered.length !== 1 ? 's' : '');

            filtered.forEach((t, idx) => {
                const taskIndex = tasks.indexOf(t);
                const row = document.createElement('div');
                row.className = 'task-row' + (t.context ? ' has-context' : '');
                row.dataset.agent = t.agent;
                row.onclick = () => openTaskDetail(taskIndex);
                row.innerHTML = `
                    <div class="task-name">
                        ${t.name}
                        ${t.context ? '<span class="context-indicator" title="Has context from Mike">üìù</span>' : ''}
                        ${t.agentPlan ? '<span class="plan-indicator" title="Agent has a plan">ü§ñ</span>' : ''}
                    </div>
                    <div class="task-agent">${t.agent}</div>
                    <div class="task-status"><span class="task-status-badge" style="background:${statusTaskColors[t.status]}15;color:${statusTaskColors[t.status]};">${t.status}</span></div>
                    <div class="task-priority"><span class="priority-dot" style="background:${priorityColors[t.priority]};"></span>${t.priority}</div>
                    <div class="task-started">${t.started}</div>
                `;
                list.appendChild(row);
            });
            updateFilterBtnText();
            highlightAgentTasks();
        }

        buildDropdown(document.getElementById('agentFilterDropdown'), agentNames, selectedAgents, renderTasks);
        buildDropdown(document.getElementById('statusFilterDropdown'), statusNames, selectedStatuses, renderTasks);

        // Make rerenderTasks available globally for modal functions
        window.rerenderTasks = function() {
            if (currentView === 'kanban') {
                renderKanban();
            } else {
                renderTasks();
            }
            renderSidebarAgents();
        };

        // Toggle dropdowns
        document.getElementById('agentFilterBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('agentFilterDropdown').classList.toggle('open');
            document.getElementById('statusFilterDropdown').classList.remove('open');
        });
        document.getElementById('statusFilterBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('statusFilterDropdown').classList.toggle('open');
            document.getElementById('agentFilterDropdown').classList.remove('open');
        });
        document.addEventListener('click', () => {
            document.querySelectorAll('.multi-select-dropdown').forEach(d => d.classList.remove('open'));
        });

        renderSidebarAgents();
        renderTasks();

        // ---- View Toggle (List / Kanban) ----
        let currentView = 'list';
        const kanbanStatuses = ['Queued', 'In Progress', 'Completed', 'Blocked'];
        const kanbanStatusColors = { 'Queued': '#8892a4', 'In Progress': '#2b7de9', 'Completed': '#0f8a5f', 'Blocked': '#c4163a' };

        function getAgentStatus(agentName) {
            const a = agents.find(ag => ag.name === agentName);
            return a ? a.status : 'idle';
        }

        function getAgentColor(agentName) {
            const a = agents.find(ag => ag.name === agentName);
            return a ? a.color : '#8892a4';
        }

        function renderKanban() {
            const board = document.getElementById('kanbanBoard');
            board.innerHTML = '';

            const filtered = tasks.filter(t => {
                const agentMatch = selectedAgents.has('All Agents') || selectedAgents.has(t.agent);
                const statusMatch = selectedStatuses.has('All') || selectedStatuses.has(t.status);
                return agentMatch && statusMatch;
            });
            document.getElementById('filterCount').textContent = filtered.length + ' task' + (filtered.length !== 1 ? 's' : '');
            updateFilterBtnText();

            kanbanStatuses.forEach(status => {
                const col = document.createElement('div');
                col.className = 'kanban-column';

                const colTasks = filtered.filter(t => t.status === status);

                col.innerHTML = `
                    <div class="kanban-column-header">
                        <div class="kanban-column-title">
                            <span class="kanban-column-dot" style="background:${kanbanStatusColors[status]};"></span>
                            ${status}
                        </div>
                        <span class="kanban-column-count">${colTasks.length}</span>
                    </div>
                `;

                const cardsContainer = document.createElement('div');
                cardsContainer.className = 'kanban-cards';

                colTasks.forEach(t => {
                    const taskIndex = tasks.indexOf(t);
                    const agentColor = getAgentColor(t.agent);
                    const card = document.createElement('div');
                    card.className = 'kanban-card' + (t.context ? ' has-context' : '');
                    card.dataset.agent = t.agent;
                    card.style.borderTopColor = agentColor;
                    card.onclick = () => openTaskDetail(taskIndex);
                    card.innerHTML = `
                        <div class="kanban-card-agent-badge" style="background:${agentColor};">${t.agent}</div>
                        <div class="kanban-card-name">${t.name}</div>
                        <div class="kanban-card-meta">
                            <div class="kanban-card-priority">
                                <span class="priority-dot" style="background:${priorityColors[t.priority]};"></span>
                                ${t.priority}
                            </div>
                            ${t.agentPlan ? '<span class="plan-badge" title="Agent has a plan">ü§ñ Plan</span>' : ''}
                        </div>
                        ${t.context ? '<div class="kanban-card-context"><span class="context-indicator">üìù</span> Context from Mike</div>' : ''}
                    `;
                    cardsContainer.appendChild(card);
                });

                col.appendChild(cardsContainer);
                board.appendChild(col);
            });

            highlightKanbanCards();
        }

        function highlightKanbanCards() {
            const agentColor = selectedAgent ? getAgentColor(selectedAgent) : null;
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.style.removeProperty('--agent-glow');
                if (!selectedAgent) {
                    card.classList.remove('highlight', 'dimmed');
                } else if (card.dataset.agent === selectedAgent) {
                    card.classList.add('highlight');
                    card.classList.remove('dimmed');
                    card.style.setProperty('--agent-glow', agentColor);
                } else {
                    card.classList.add('dimmed');
                    card.classList.remove('highlight');
                }
            });
        }

        function setView(view) {
            currentView = view;
            const listEl = document.getElementById('taskList');
            const boardEl = document.getElementById('kanbanBoard');
            const listBtn = document.getElementById('listViewBtn');
            const kanbanBtn = document.getElementById('kanbanViewBtn');

            if (view === 'list') {
                listEl.style.display = '';
                boardEl.style.display = 'none';
                listBtn.classList.add('active');
                kanbanBtn.classList.remove('active');
                renderTasks();
            } else {
                listEl.style.display = 'none';
                boardEl.style.display = 'flex';
                listBtn.classList.remove('active');
                kanbanBtn.classList.add('active');
                renderKanban();
            }
        }

        document.getElementById('listViewBtn').addEventListener('click', () => setView('list'));
        document.getElementById('kanbanViewBtn').addEventListener('click', () => setView('kanban'));

        // Patch renderTasks and highlightAgentTasks to also handle kanban
        const origRenderTasks = renderTasks;
        renderTasks = function() {
            if (currentView === 'kanban') { renderKanban(); return; }
            origRenderTasks();
        };

        const origHighlight = highlightAgentTasks;
        highlightAgentTasks = function() {
            origHighlight();
            if (currentView === 'kanban') highlightKanbanCards();
        };

        // ---- Activity Feed ----
        const activities = [
            { agent: 'Beacon', text: 'Generated 12 SEO pages ‚Äî pending Loki review', time: '2 min ago', color: '#0d8aba' },
            { agent: 'Pixel', text: 'Completed blog post: "5 Landing Page Mistakes"', time: '15 min ago', color: '#5b5fcf' },
            { agent: 'Forge', text: 'Queued email campaign draft for approval', time: '30 min ago', color: '#c67a08' },
            { agent: 'Radar', text: 'Hit Twitter API rate limit ‚Äî backing off 15min', time: '45 min ago', color: '#c4163a' },
            { agent: 'Atlas', text: 'Published weekly analytics summary to shared memory', time: '1 hr ago', color: '#0f8a5f' },
            { agent: 'Loki', text: 'Approved and sent 3 email campaigns', time: '1.5 hr ago', color: '#2b7de9' }
        ];

        const feedEl = document.getElementById('activityFeed');
        activities.forEach(a => {
            const item = document.createElement('div');
            item.className = 'activity-item';
            item.innerHTML = `
                <div class="activity-dot" style="background:${a.color};"></div>
                <div class="activity-content">
                    <div class="activity-text"><strong>${a.agent}</strong> ${a.text}</div>
                    <div class="activity-time">${a.time}</div>
                </div>
            `;
            feedEl.appendChild(item);
        });

        // ---- Alert Log ----
        const alerts = [
            { level: 'error', text: 'Radar: Twitter API rate limit (auto-retry in 15min)', time: '45 min ago' },
            { level: 'warning', text: 'Beacon: 2 pages flagged for thin content ‚Äî queued for Loki review', time: '1 hr ago' }
        ];

        const alertEl = document.getElementById('alertLog');
        alerts.forEach(a => {
            const item = document.createElement('div');
            item.className = 'alert-item alert-' + a.level;
            item.innerHTML = `
                <div class="alert-icon">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                </div>
                <div class="alert-content">
                    <div class="alert-text">${a.text}</div>
                    <div class="alert-time">${a.time}</div>
                </div>
            `;
            alertEl.appendChild(item);
        });

    })();
    </script>
</body>
</html>
